# 第 1 周 案例研究：预期寿命研究

## 关于本案例研究

本实操练习将引导你探索一项健康数据案例研究。你可参考电子书（点击链接跳转至外部网站），回顾如何对数据执行特定操作。

你将看到一份 R 脚本草稿（文件名为 “CaseStudy_LifeExpectancy_Prompts.R”），该脚本与数据文件一同提供。请下载这两个文件并将其放入同一个文件夹中，在该文件夹内创建一个名为 “data” 的子文件夹，然后将数据文件移入 “data” 子文件夹。接着启动 RStudio，并将上述主文件夹设置为工作目录。

- 案例研究任务说明文档：CaseStudy_LifeExpectancy_TasksDescription.docx（可点击操作下载）
- 预期寿命术语表：Life_Expectancy_Glossary.docx（可点击操作下载）
- 预期寿命数据文件：Life Expectancy Data.csv（点击 “Download Life Expectancy Data.csv” 下载）
- R 脚本草稿：CaseStudy_LifeExpectancy_Prompts.R（点击 “Download CaseStudy_LifeExpectancy_Prompts.R” 下载）

## 案例研究示例答案

（将于 10 月 3 日发布）

### 补充说明：

1. 文件名均保留原英文名称，因在 RStudio 中使用英文文件名可避免路径识别错误（R 对中文路径兼容性较差）；
2. “working directory” 为 R 语言术语，指 “工作目录”，即 RStudio 默认读取和保存文件的路径；
3. “draft R script” 译为 “R 脚本草稿”，“prompts” 在此处指脚本中预设的代码提示，帮助使用者逐步完成数据分析任务。

# 预期寿命数据案例研究：各步骤详细操作指南

## 0) 环境设置（Setup）

### 操作目的

确保 R 能正确读取数据文件，为后续分析做好准备。

### 详细步骤

1. **设置工作目录**
    
    ```r
    # 方法1：通过路径设置（替换为你的实际路径）
    setwd("C:/Users/你的用户名/Desktop/LifeExpectancy_Study")
    
    # 方法2：通过RStudio菜单设置
    # Session → Set Working Directory → Choose Directory → 选择主文件夹
    
    # 验证工作目录是否正确
    getwd()  # 输出应显示你的主文件夹路径
    ```
    
2. **读取 CSV 数据**
    
    r
    
    ```r
    # 读取数据到data对象，check.names=FALSE保留原始列名（含空格的列名）
    data <- read.csv("./data/Life Expectancy Data.csv", check.names = FALSE)
    
    # 验证数据是否读取成功
    if (exists("data")) {
      print("数据读取成功！")
    } else {
      print("数据读取失败，请检查路径是否正确")
    }
    ```
    
3. **加载 ggplot2 包（可选）**
    
    r
    
    ```r
    # 若未安装，先执行安装命令（只需运行一次）
    # install.packages("ggplot2")
    
    # 加载包
    library(ggplot2)
    ```
    

## 1) 数据初览（First look at the data）

### 操作目的

初步了解数据的基本结构、内容和格式，判断数据是否符合预期。

### 详细步骤

1. **查看首尾数据**
    
    r
    
    ```r
    # 查看前6行
    head(data)
    
    # 查看后6行
    tail(data)
    ```
    
2. **随机抽样 10 行**
    
    r
    
    ```r
    # 生成10个随机行号（nrow(data)获取总行数）
    set.seed(123)  # 设置随机种子，确保结果可复现
    random_rows <- sample.int(nrow(data), 10)
    
    # 提取随机行
    data[random_rows, ]
    ```
    
3. **查看数据维度**
    
    
    ```r
    # 同时查看行数和列数
    dim(data)  # 输出格式：行数 列数
    
    # 单独查看行数
    nrow(data)
    
    # 单独查看列数
    ncol(data)
    ```
    
4. **检查数据类型和统计摘要**
    
    r
    
    ```r
    # 查看各列数据类型（数值型、字符型等）
    str(data)
    
    # 查看统计摘要（均值、中位数、最值等）
    summary(data)
    ```
    
5. **检查重复的国家 - 年份组合**
    
    r
    
    ```r
    # 检查Country和Year列的重复组合
    duplicates <- duplicated(data[, c("Country", "Year")])
    
    # 统计重复数量
    sum(duplicates)  # 输出0表示无重复，>0表示有重复
    
    # 查看重复的行（若存在）
    if (sum(duplicates) > 0) {
      data[duplicates, c("Country", "Year")]
    }
    ```
    

## 2) 数据清洗与缺失值处理（Data hygiene & missingness）

### 操作目的

识别缺失值的分布情况，为后续处理提供依据。

### 详细步骤

1. **统计每列缺失值数量**
    
    r
    
    ```r
    # 计算每列NA的数量
    na_count <- colSums(is.na(data))
    #is.na这里会生成和原始数据同行同列但是显示TF的表格
    
    # 按缺失值数量从多到少排序，decreasing=TRUE是从大到小
    sort(na_count, decreasing = TRUE)
    ```
    
2. **计算每列缺失值百分比**
    
    r
    
    ```r
    # 计算每列缺失值百分比（保留2位小数）先把缺失值设置为TRUE然后colMean计算每列的平均缺失值然后乘100变成百分数，round是四舍五入保留两位
    na_percent <- round(colMeans(is.na(data)) * 100, 2)    
    # 按百分比从高到低排序
    sort(na_percent, decreasing = TRUE)
    ```
    
3. **计算整体缺失值比例**
    
    r
    
    ```r
    # 数据中所有单元格的缺失比例（保留2位小数）这里的mean是计算总体的缺失值，是一个单独的数字
    overall_na <- round(mean(is.na(data)) * 100, 2)
    cat("整体缺失值比例：", overall_na, "%\n")
    ```
    
4. **用国家均值填补 GDP 缺失值（可选）**
    
    r
    
    ```r
    # 按国家分组计算GDP均值，填补NA（ave()函数按组计算）
    data$GDP <- ave(data$GDP, data$Country, 
                   FUN = function(x) ifelse(is.na(x), mean(x, na.rm = TRUE), x))
    # data$GDP表示要处理GDP这一列，data¥Country分组依据，按国家分组
    # 验证GDP列的缺失值是否已处理
    sum(is.na(data$GDP))  # 输出0表示填补完成（若原数据中每个国家至少有一个非NA值）
    
    #分组看起来是这样的
#   Country Year GDP
# 1     中国 2018  13
# 2     中国 2019  NA
# 3     中国 2020  15
# 4     美国 2018  20
# 5     美国 2019  21
# 6     美国 2020  NA

**翻译**：ifelse(test, yes, no)

**解释**：这是 `ifelse` 的标准调用格式，三个参数缺一不可：

- `test`：用来判断的 “条件向量”；
- `yes`：条件为 `TRUE` 时要填的值；
- `no`：条件为 `FALSE` 时要填的值。
```

但是这里出现了一个问题，上述运行后还是出现了405个NA，
```r
#发现如北朝鲜等国家全是NA，看后续情况再做删除
gdp_by_country <- split(data$GDP, data$Country)
```

## 3) 分布与基础探索性数据分析（Distributions & basic EDA）

### 操作目的

了解关键变量的分布特征和分组差异。

### 详细步骤

1. **绘制直方图**
    
    r
    
    ```r
    # 方法1：使用基础R绘制预期寿命直方图
    hist(data$`Life expectancy`, 
         main = "预期寿命分布", 
         xlab = "预期寿命（年）", 
         col = "lightblue",
         border = "white")
    
    # 方法2：使用ggplot2绘制BMI直方图
    ggplot(data, aes(x = BMI)) +
      geom_histogram(fill = "lightgreen", color = "black", bins = 30) +
      labs(title = "BMI分布", x = "体重指数", y = "频数") +
      theme_minimal()
    ```
    
2. **绘制分组箱线图**
    
    r
    
    ```r
    # 方法1：基础R绘制预期寿命按Status分组的箱线图
    boxplot(`Life expectancy` ~ Status, data = data,
            main = "不同发展状态国家的预期寿命",
            xlab = "国家状态", ylab = "预期寿命（年）",
            col = c("pink", "lightblue"))
    
    # 方法2：ggplot2绘制
    ggplot(data, aes(x = Status, y = `Life expectancy`, fill = Status)) +
      geom_boxplot() +
      labs(title = "不同发展状态国家的预期寿命", x = "国家状态", y = "预期寿命（年）") +
      theme_minimal() +
      guides(fill = "none")  # 去除图例
    ```
    
3. **分组统计摘要**
    
    r
    
    ```r
    # 按Status分组计算预期寿命的均值和标准差
    tapply(data$`Life expectancy`, data$Status, function(x) {
      c(mean = mean(x, na.rm = TRUE), sd = sd(x, na.rm = TRUE))
    })
    
    # 按Status分组计算GDP的中位数
    tapply(data$GDP, data$Status, median, na.rm = TRUE)
    
    # 按Status分组计算学校教育年限的均值
    tapply(data$Schooling, data$Status, mean, na.rm = TRUE)
    ```
    

## 4) 关系与相关性分析（Relationships & correlations）

### 操作目的

探索变量之间的关联模式，尤其是与预期寿命相关的因素。

### 详细步骤

1. **计算相关矩阵**
    
    r
    
    ```r
    # 提取所有数值型列（排除字符型列如Country、Status）
    numeric_cols <- sapply(data, is.numeric)
    data_numeric <- data[, numeric_cols]
    
    # 计算相关矩阵（仅对非缺失值计算）
    corr_matrix <- cor(data_numeric, use = "complete.obs")
    
    # 查看相关矩阵（保留2位小数）
    round(corr_matrix, 2)
    ```
    
2. **计算与预期寿命的相关性**
    
    r
    ```r
    # 提取需要分析的变量
    variables <- c("GDP", "Schooling", "BMI", "HIV.AIDS", "Adult Mortality")
    
    # 计算每个变量与预期寿命的相关系数
    sapply(variables, function(var) {
      cor(data$`Life expectancy`, data[[var]], use = "complete.obs")
    }) %>% round(3)  # 保留3位小数
    ```
    
1. **绘制散点图与趋势线**
    r
    
    ```r
    # 方法1：基础R绘制GDP与预期寿命的散点图+趋势线
    plot(data$GDP, data$`Life expectancy`,
         xlab = "GDP", ylab = "预期寿命（年）",
         main = "GDP与预期寿命的关系",
         pch = 16, col = rgb(0, 0, 1, 0.3))  # 半透明蓝色点
    
    # 添加线性趋势线
    abline(lm(`Life expectancy` ~ GDP, data = data), col = "red", lwd = 2)
    
    # 方法2：ggplot2绘制并添加loess平滑曲线
    ggplot(data, aes(x = GDP, y = `Life expectancy`)) +
      geom_point(alpha = 0.3, color = "blue") +
      geom_smooth(method = "loess", se = FALSE, color = "red") +  # 局部加权回归曲线
      labs(title = "GDP与预期寿命的关系", x = "GDP", y = "预期寿命（年）") +
      theme_minimal()
    ```
1. **生成成对散点图矩阵**
    ```r
    # 选择需要分析的变量（包括预期寿命）
    selected_vars <- c("Life expectancy", "GDP", "Schooling", "BMI", "HIV.AIDS")
    
    # 绘制散点图矩阵
    pairs(data[, selected_vars],
          main = "变量间成对关系散点图矩阵",
          pch = 16, cex = 0.5, col = rgb(0, 0.5, 0, 0.3))
    ```
## 5) 编程实践（Programming practice）

### 操作目的

通过函数、循环和条件判断等编程技巧，加深对数据的理解
### 详细步骤

1. **编写函数：计算指定国家的预期寿命均值**

    
    ```r
    # 定义函数：输入国家名称，返回预期寿命均值
    country_lifeexp_mean <- function(country_name) {
      # 筛选指定国家的数据
      country_data <- data[data$Country == country_name, "Life expectancy"]
      
      # 处理国家不存在的情况
      if (length(country_data) == 0) {
        return(paste("错误：未找到", country_name, "的数据"))
      }
      
      # 计算均值（忽略NA）
      mean_le <- mean(country_data, na.rm = TRUE)
      return(round(mean_le, 2))
    }
    
    # 测试函数（例如中国）
    country_lifeexp_mean("China")
    
    # 测试另一个国家（例如美国）
    country_lifeexp_mean("United States of America")
    ```
    
2. **循环：每年预期寿命排名前 3 的国家**
    
    r
    
    ```r
    # 获取所有年份（去重）
    years <- unique(data$Year)
    
    # 按年份循环
    for (year in years) {
      # 筛选该年份的数据，去除预期寿命为NA的行
      year_data <- data[data$Year == year & !is.na(data$`Life expectancy`), ]
      
      # 按预期寿命降序排序
      year_data_sorted <- year_data[order(-year_data$`Life expectancy`), ]
      
      # 取前3名（若数据不足3行则取全部）
      top3 <- head(year_data_sorted[, c("Country", "Life expectancy")], 3)
      
      # 打印结果
      cat("年份：", year, "\n")
      print(top3)
      cat("\n")  # 空行分隔
    }
    ```
    
3. **条件判断：创建预期寿命分类列**
    
    r
    
    ```r
    # 使用ifelse创建新列lifeexp_flag
    data$lifeexp_flag <- ifelse(data$`Life expectancy` < 50, 
                               "Low",  # <50标记为Low
                               ifelse(data$`Life expectancy` > 80, 
                                      "High",  # >80标记为High
                                      "Typical"))  # 其余为Typical
    
    # 查看新列的分布
    table(data$lifeexp_flag)
    ```
    

## 6) 可用于报告的输出结果（Reporting-ready outputs）

### 操作目的

生成规范的统计表格和可视化结果，便于报告撰写。

### 详细步骤

1. **生成分组统计摘要表**
    
    r
    
    ```r
    # 使用aggregate()按Status分组计算多个变量的均值
    summary_table <- aggregate(
      cbind(`Life expectancy`, Schooling, GDP) ~ Status,  # 需计算的变量
      data = data,
      FUN = function(x) round(mean(x, na.rm = TRUE), 2)  # 计算均值并保留2位小数
    )
    
    # 查看结果
    print(summary_table)
    
    # 可选：将结果保存为CSV文件（便于导入报告）
    write.csv(summary_table, "summary_by_status.csv", row.names = FALSE)
    ```
    
2. **保存图形到文件**
    
    r
    
    ```r
    # 保存GDP与预期寿命的散点图为PNG文件
    png("GDP_vs_LifeExpectancy.png", width = 800, height = 600)  # 设置文件格式和尺寸
    
    # 绘制图形
    ggplot(data, aes(x = GDP, y = `Life expectancy`)) +
      geom_point(alpha = 0.3) +
      geom_smooth(method = "lm", color = "red") +
      labs(title = "GDP与预期寿命的关系", x = "GDP", y = "预期寿命（年）") +
      theme_minimal()
    
    dev.off()  # 关闭图形设备，完成保存
    ```
    

## 7) 反思提示（Reflection prompts）

### 思考方向

1. **关联性最强的指标**：查看相关系数结果，通常 Schooling（教育年限）、GDP 与预期寿命呈正相关，HIV.AIDS、Adult Mortality（成人死亡率）呈负相关。
2. **发达国家与发展中国家的差异**：通过箱线图和分组统计，发达国家的预期寿命普遍更高，GDP 和教育水平也更高。
3. **缺失值处理的影响**：均值填补可能会缩小数据变异，导致相关性被低估或高估，需谨慎解释结果。
4. **相关性的局限性**：相关性≠因果关系（如 GDP 与预期寿命相关，可能是因为医疗资源等第三方因素）。
5. **后续探索方向**：可分析不同年份的变化趋势、加入交互项（如 GDP 与教育的共同影响），或对 GDP 进行对数转换（因 GDP 分布通常右偏）。

通过以上步骤，你可以系统地完成案例研究的所有核心任务，从数据准备到深入分析，再到结果呈现，全面掌握健康数据的分析流程。

分享